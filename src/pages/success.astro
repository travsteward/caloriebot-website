---
import Layout from '../layouts/Layout.astro';

// Get session_id and guild_id from URL
const url = new URL(Astro.request.url);
const sessionId = url.searchParams.get('session_id');
const guildId = url.searchParams.get('guild_id');
const permissions = url.searchParams.get('permissions');

// Construct bot invite URL (simplified for bot installation)
const BOT_INVITE_URL = `https://discord.com/api/oauth2/authorize?` + new URLSearchParams({
  client_id: import.meta.env.DISCORD_CLIENT_ID,
  guild_id: guildId || '',
  permissions: permissions || '395137251392',
  scope: 'bot applications.commands'
}).toString();

// If we have both sessionId and guildId, update the subscription
if (sessionId && guildId) {
  try {
    const response = await fetch('/.netlify/functions/update-guild', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        sessionId,
        guildId,
      })
    });

    if (!response.ok) {
      console.error('Failed to update guild');
    }
  } catch (error) {
    console.error('Error:', error);
  }
}
---

<Layout title="Payment Successful - CalorieBot">
  <main class="min-h-screen bg-dark flex items-center justify-center">
    <div class="container mx-auto px-4 max-w-lg text-center">
      <div class="bg-secondary p-8 rounded-lg shadow-lg">
        <div class="text-5xl mb-6">ðŸŽ‰</div>
        <h1 class="text-3xl font-bold text-discord mb-4">Payment Successful!</h1>
        <p class="text-gray-300 mb-6">
          Thank you for subscribing to CalorieBot. Click below to complete setup:
        </p>
        <a
          href={BOT_INVITE_URL}
          class="block bg-discord hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition-colors"
        >
          Add to Server
        </a>
      </div>
    </div>
  </main>
</Layout>